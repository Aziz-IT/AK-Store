<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AK Store Order Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.min.js"></script>

    <style>
       
       /* General Reset */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* Body Styling */
body {
  font-family: Arial, sans-serif;
  display: flex;
  height: 100vh;
}

/* Sidebar */
.sidebar {
  background-color: #263238; /* Dark theme */
  width: 250px;
  color: #FFFFFF;
  display: flex;
  flex-direction: column;
  padding: 20px;
}

.logo-container {
  display: flex;
  justify-content: center;
  margin-bottom: 30px;
}

.logo {
  width: 80%;
}

.sidebar-nav {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}

.sidebar-btn {
  background-color: #4CAF50;
  color: #FFFFFF;
  padding: 10px 20px;
  text-align: center;
  margin: 10px 0;
  text-decoration: none;
}

.sidebar-signout {
  background-color: #f44336;
  color: #FFFFFF;
  padding: 10px 20px;
  text-align: center;
  margin: 10px 0;
  text-decoration: none;
  align-self: flex-end;
}

.spacer {
  flex-grow: 1;
}

/* Main Content */
.main-content {
  flex-grow: 1;
  background-color: #F4F6F8;
  padding: 20px;
}

/* Navbar */
.navbar {
  background-color: #37474F;
  color: #FFFFFF;
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.navbar-brand {
  font-size: 24px;
}

.navbar-nav .navbar-signout {
  background-color: #f44336;
  color: #FFFFFF;
  padding: 8px 15px;
  text-decoration: none;
  border-radius: 4px;
}

.navbar-signout:hover {
  background-color: #d32f2f;
}

/* Orders Table */
.content h2 {
  color: #37474F;
  margin-bottom: 15px;
}

.table {
  width: 100%;
  border-collapse: collapse;
  background-color: #FFFFFF;
}

.table thead th {
  background-color: #37474F;
  color: #FFFFFF;
  padding: 10px;
}

.table tbody td {
  padding: 10px;
  border-bottom: 1px solid #E0E0E0;
}




        body {
            font-family: Arial, sans-serif;
            background-image: url('static/images/logo.jpg');
            background-size: cover;
            background-position: center 4%;
            color: #333;
            padding: 20px;
            text-align: center;
            opacity: 0.9;
        }
    
        input,
        button,
        select {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 200px;
            transition: border-color 0.3s;
        }
    
        input:focus {
            border-color: #3a5d30;
            outline: none;
        }
    
        button {
            background-color: #3a5d30;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
    
        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
    
        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
    
    
        th,
        td {
            border: 1px solid #4CAF50;
            padding: 10px;
            text-align: left;
            background-color: rgba(255, 255, 255, 0.9);
        }
    
        th {
            background-color: #3a5d30;
            color: white;
        }
    
        .no-orders {
            margin-top: 20px;
            color: red;
        }
    
        .loading {
            display: none;
            color: #3a5d30;
            font-weight: bold;
            margin-top: 20px;
        }
    
        .toastr {
            font-size: 18px;
            padding: 15px;
        }
    
        .popup {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
    
        .popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
        }
    
        .close {
            cursor: pointer;
            color: red;
            font-size: 40px;
        }
        .signout-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: #3a5d30;
        color: white;
        border: none;
        cursor: pointer;
        padding: 10px 15px;
        border-radius: 5px;
        font-size: 16px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s, transform 0.2s;
    }

    .signout-btn:hover {
        background-color: #45a049;
        transform: translateY(-2px);
    }

    .signout-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    /* Dark mode styles */
body.dark-mode {
    background-color: #121212;
    color: #e0e0e0;
}

body.dark-mode button {
    background-color: #2e7d32;
    color: #f8f9fa;
}

body.dark-mode table {
    background-color: rgba(40, 40, 40, 0.9);
}

body.dark-mode th {
    background-color: #2e7d32;
    color: #e0e0e0;
}

/* Style for the order details table in the modal */
/* Refined styles for modal */
#order_details_modal {
    display: none;
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    justify-content: center;
    align-items: center;
    overflow: auto;
    z-index: 1000;
}

/* Modal content box with fixed size and scrollable content */
#order_details_modal .popup-content {
    background-color: white;
    width: 80%;
    max-width: 600px;
    max-height: 80vh;
    padding: 20px;
    border-radius: 10px;
    overflow-y: auto;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
}

/* Table styling within the modal */
#order_details_modal table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

#order_details_modal th,
#order_details_modal td {
    padding: 8px 12px;
    border: 1px solid #ddd;
    text-align: left;
}

#order_details_modal th {
    background-color: #3a5d30;
    color: white;
    position: sticky;
    top: 0;
}

#order_details_modal h2 {
    font-size: 24px;
    margin-bottom: 10px;
    text-align: center;
}

/* Buttons within the modal table */
#order_details_modal td button {
    padding: 5px 10px;
    margin: 3px;
    font-size: 14px;
    border: none;
    background-color: #3a5d30;
    color: white;
    border-radius: 3px;
    cursor: pointer;
    transition: background-color 0.3s;
}

#order_details_modal td button:hover {
    background-color: #45a049;
}


    </style>
    
</head>

<body>
    <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-container">
      <img src="A:/Dev/backup/AK store/api/static/images/logo.png" alt="AK Store Logo" class="logo">
    </div>
    <nav class="sidebar-nav">
      <a href="/add_order.html" class="sidebar-btn">Add New Order</a>
      <div class="spacer"></div>
      <a href="javascript:void(0);" class="sidebar-signout" onclick="openLogoutPopup()">Sign Out</a>
    </nav>
  </aside>

  <!-- Main Content Area -->
  <main class="main-content">
    <!-- Navigation Bar -->
    <header class="navbar">
      <div class="navbar-brand">AK Store Dashboard</div>
      <nav class="navbar-nav">
        <!-- Sign Out Link in Navbar -->
        <button class="signout-btn" onclick="openLogoutPopup()">Sign Out</button>

      </nav>
    </header>

    <h1>Welcome to AK Store Order Tracker</h1>
    <div id="loading_indicator" class="loading">Loading...</div>
<!-- Add the Sign Out button here -->
<button class="signout-btn" aria-label="Sign Out" onclick="openLogoutPopup()">Sign Out</button>
<button id="themeToggle" aria-label="Toggle Dark Mode">Toggle Dark Mode</button>

<div id="logout_popup" class="popup">
    <div class="popup-content">
        <span class="close" onclick="closeLogoutPopup()">&times;</span>
        <h2>Confirm Logout</h2>
        <p>Are you sure you want to log out?</p>
        <button onclick="confirmLogout()">Yes</button>
        <button onclick="closeLogoutPopup()">No</button>
    </div>
</div>

<!-- Order Details Modal -->
<div id="order_details_modal" class="popup">
    <div class="popup-content">
        <span class="close" onclick="closeOrderDetailsModal()">&times;</span>
        <!-- <h2>Order Details</h2> -->
        <div id="order_details_content"></div>
    </div>
</div>


    <input type="text" id="search_input" placeholder="Order ID or Customer Name" aria-label="Search Orders">
    <select id="status_filter" aria-label="Filter by Status">
        <option value="">All Status</option>
        <option value="noted">Noted</option>
        <option value="ordered">Ordered</option>
        <option value="delivered">Delivered</option>
        <option value="other">Other</option>
    </select>
    <button id="toggle_orders_btn" aria-label="Toggle Orders">Show All Orders</button>
    <button aria-label="Add New Order" onclick="window.location.href='/add_order.html'">Add New Order</button>

    <div class="results" id="results">
        <table id="orders_table" style="display: none;">
            <thead>
                <tr>
                    <th>Customer Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="ordersBody"></tbody>
        </table>
        <div class="no-orders" id="no_orders_message" style="display: none;">No orders currently available.</div>
    </div>

    <div id="popup" class="popup">
        <div class="popup-content">
            <span class="close" onclick="closePopup()">&times;</span>
            <h2>Update Order Status</h2>
            <label for="popup_order_id">Order ID:</label>
            <input type="text" id="popup_order_id" disabled>
            <label for="popup_status">Status:</label>
            <select id="popup_status" onchange="toggleOtherStatusInput()">
                <option value="noted">Noted</option>
                <option value="ordered">Ordered</option>
                <option value="delivered">Delivered</option>
                <option value="other">Other</option>
            </select>
            <input type="text" id="popup_other_status" placeholder="Specify status" style="display: none;" />
            <button id="popup_update_button" onclick="updatePopupStatus()">Update</button>
        </div>
    </div>

    <script>

document.addEventListener("DOMContentLoaded", function () {
  const signOutLinks = document.querySelectorAll(".sidebar-signout, .navbar-signout");
  signOutLinks.forEach(link => {
    link.addEventListener("click", () => {
      // Implement the actual sign-out logic here
      console.log("Signing out..."); // Replace with actual sign-out process
    });
  });
});

        // Optional: Toggle sidebar visibility on small screens
document.querySelector('.toggle-sidebar').addEventListener('click', () => {
    document.querySelector('.sidebar').classList.toggle('active');
});


        
            function openLogoutPopup() {
                document.getElementById('logout_popup').style.display = 'flex';
            }

            function closeLogoutPopup() {
                document.getElementById('logout_popup').style.display = 'none';
            }

            function confirmLogout() {
                window.location.href = '/logout';
            }


            // On page load, set theme based on saved preference in localStorage
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
    }
});

// Toggle dark mode and save preference to localStorage
document.getElementById('themeToggle').addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
    localStorage.setItem('theme', currentTheme);
});


        document.getElementById('toggle_orders_btn').onclick = async () => {
            const ordersTable = document.getElementById('orders_table');
            const noOrdersMessage = document.getElementById('no_orders_message');
            const toggleButton = document.getElementById('toggle_orders_btn');

            if (ordersTable.style.display === 'table') {
                ordersTable.style.display = 'none';
                noOrdersMessage.style.display = 'none';
                toggleButton.textContent = 'Show Orders';
            } else {
                await showAllOrders();
                ordersTable.style.display = 'table';
                noOrdersMessage.style.display = 'none';
                toggleButton.textContent = 'Hide Orders';
            }
        };

        document.getElementById('search_input').addEventListener('input', async () => {
            const searchTerm = document.getElementById('search_input').value.trim();
            if (searchTerm === '') {
                document.getElementById('orders_table').style.display = 'none';
                document.getElementById('no_orders_message').style.display = 'none';
            } else {
                await searchOrders(searchTerm);
            }
        });

        document.getElementById('status_filter').addEventListener('change', async () => {
            const selectedStatus = document.getElementById('status_filter').value;
            await filterOrdersByStatus(selectedStatus);
        });

        async function showAllOrders() {
    const loadingIndicator = document.getElementById('loading_indicator');
    loadingIndicator.style.display = 'block';
    try {
        const response = await fetch('/show_all');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        // Group orders by customer name
        const ordersByCustomer = {};
        data.forEach(order => {
            const customerName = order.customer_name;
            if (!ordersByCustomer[customerName]) {
                ordersByCustomer[customerName] = [];
            }
            ordersByCustomer[customerName].push(order);
        });

        displayOrders(ordersByCustomer);  // Pass the grouped data to displayOrders
    } catch (error) {
        toastr.error('Failed to fetch orders. Check console for details.');
    } finally {
        loadingIndicator.style.display = 'none';
    }
}



        async function searchOrders(searchTerm) {
            try {
                const response = await fetch('/search_orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ search_term: searchTerm })
                });
                const data = await response.json();
                if (data.result.length > 0) {
                    displayOrders(data.result);
                } else {
                    document.getElementById('orders_table').style.display = 'none';
                    document.getElementById('no_orders_message').style.display = 'block';
                }
            } catch (error) {
                console.error('Error searching orders:', error);
                toastr.error('Failed to search orders. Check console for details.');
            }
        }

        async function filterOrdersByStatus(status) {
            try {
                const response = await fetch('/filter_orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });
                const data = await response.json();
                displayOrders(data);
            } catch (error) {
                console.error('Error filtering orders:', error);
                toastr.error('Failed to filter orders. Check console for details.');
            }
        }

        
        // Updated displayOrders function
function displayOrders(ordersByCustomer) {
    const ordersBody = document.getElementById('ordersBody');
    ordersBody.innerHTML = ''; // Clear existing rows

    for (const customerName in ordersByCustomer) {
        const customerOrders = ordersByCustomer[customerName];

        // Create a row with customer name and "View Orders" button
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${customerName || 'N/A'}</td>
            <td><button onclick="openOrderDetailsModal('${customerName}')">View Orders</button></td>
        `;
        
        // Store customer orders in a map by customer name
        window.ordersMap = window.ordersMap || {};
        window.ordersMap[customerName] = customerOrders;

        ordersBody.appendChild(row);
    }
}


function openOrderDetailsModal(customerName) {
    const orderDetailsContent = document.getElementById('order_details_content');
    orderDetailsContent.innerHTML = ''; // Clear previous content

    // Retrieve customer orders from the stored ordersMap
    const customerOrders = window.ordersMap[customerName] || [];

    // Create table layout for orders
    const tableHTML = `
        <h2>${customerName}</h2>
        <table>
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Order Details</th>
                    <th>Order Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${customerOrders.map(order => `
                    <tr>
                        <td>${order.order_id || 'N/A'}</td>
                        <td>${order.order_details || 'N/A'}</td>
                        <td>${order.order_date || 'N/A'}</td>
                        <td>${order.status || 'N/A'}</td>
                        <td>
                            <button onclick="openPopup('${order.order_id}')">Update</button>
                            <button onclick="deleteOrder('${order.order_id}')">Delete</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    orderDetailsContent.innerHTML = tableHTML;

    // Display the modal
    document.getElementById('order_details_modal').style.display = 'flex';
}


// Function to close the order details modal
function closeOrderDetailsModal() {
    document.getElementById('order_details_modal').style.display = 'none';
}



        async function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                try {
                    const response = await fetch('/delete_order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order_id: orderId })
                    });
                    if (response.ok) {
                        toastr.success('Order deleted successfully.');
                        await showAllOrders(); // Refresh the order list
                    } else {
                        toastr.error('Failed to delete the order.');
                    }
                } catch (error) {
                    console.error('Error deleting order:', error);
                    toastr.error('Failed to delete order. Check console for details.');
                }
            }
        }

        function openPopup(orderId) {
            document.getElementById('popup_order_id').value = orderId;
            document.getElementById('popup').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('popup_status').value = 'noted';
            document.getElementById('popup_other_status').style.display = 'none';
        }

        function toggleOtherStatusInput() {
            const otherStatusInput = document.getElementById('popup_other_status');
            otherStatusInput.style.display = document.getElementById('popup_status').value === 'other' ? 'block' : 'none';
        }

        async function updatePopupStatus() {
            const orderId = document.getElementById('popup_order_id').value;
            const status = document.getElementById('popup_status').value;
            const otherStatus = document.getElementById('popup_other_status').value;

            try {
                const response = await fetch('/update_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId, status: status === 'other' ? otherStatus : status })
                });
                if (response.ok) {
                    toastr.success('Order status updated successfully.');
                    closePopup();
                    await showAllOrders();
                } else {
                    toastr.error('Failed to update order status.');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                toastr.error('Failed to update order status. Check console for details.');
            }
        }
        

        // Initial load of orders
        showAllOrders();
    </script>
    <!-- Order Details Modal -->
<div id="order_details_modal" class="popup">
    <div class="modal-content">
        <span class="close-modal" onclick="closeOrderDetailsModal()">&times;</span>
        <div id="order_details_content"></div>
    </div>
</div>
</main>
</body>

</html>